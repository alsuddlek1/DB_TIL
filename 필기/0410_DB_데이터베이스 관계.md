# DB : 데이터베이스 관계(1:N)

## A many to one relationship

### 개요

- 관계형 데이터베이스에서의 외래 키 속성을 사용해 모델간 N:1 관계 설정하기

## Intro

### RDB(관계형 데이터 베이스)

- 데이터를 테이블, 행, 열 등으로 나누어 구조화 하는 방식

- RDB의 모든 테이블에는 행에서 고유하게 식별 가능한 기본 키라는 속성이 있으며, 외래 키를 사용하여 각 행에서 서로 다른 테이블 간의 관계를 만드는데 사용할 수 있음

### RDB에서의 관계

1. 1:1
   
   - One-to-one relationships
   
   - 한 테이블의 레코드 하나가 다른 테이블의 레코드 단 한개와 관련된 경우

2. <mark>N:1</mark>
   
   - Many-to-one relationships
   
   - 한 테이블의 0개 이상의 레코드(N개의 레코드)가 다른 테이블의 레코드 한 개와 관련된 경우
   
   - 기준 테이블에 따라(1:N, One-to-many relationships)이라고 함
   
   - 강의-학생, 게시글-댓글, 유저-게시글

3. ~~M:N~~
   
   - Many to many relationships
   
   - 한 테이블의 0개 이상의 레코드가 다른 테이블의 0개 이상의 레코드와 관련된 경우
   
   - 양쪽 모두에서 N:1 관계를 가짐
   
   - 태그-게시글, 유저-유저(?)

### 예시

![](C:\Users\SSAFY\AppData\Roaming\marktext\images\2023-04-10-08-51-11-image.png)

## Foreign key

### 개념

- 외래 키(외부키)

- 관계형 데이터베이스에서 다른 테이블의 행을 식별할 수 있는 키

- 참조되는 테이블의 기본 키(Primary key)를 가르킴

- 참조하는 테이블의 행 1개의 값은, 참조되는 측 테이블의 행 값에 대응됨
  
  - 이 때문에 참조하는 테이블의 행에는, 참조되는 테이블에 나타나지 않는 값을 포함할 수 없음

- 참조하는 테이블 행 여러개가, 참조되는 테이블의 동일한 행을 참조할 수 있음



### 특징

- 키를 사용하여 <u>부모 테이블의 유일한 값</u>을 참조

- 외래 키의 값이 반드시 부모 테이블의 기본 키(PK) 일 필요는 없지만 유일한 값이어야 함



## N:1 (Comment - Article)

### 개요

- Comment(N) - Article(1)

- Comment 모델과 Article 모델 간 관계 설정

- "0개 이상의 댓글은 1개의 게시글에 작성 될 수 있음"



## 모델 관계 설정

### 모델 관계 설정

- 게시판의 게시글과 N:1 관계를 나타낼 수 있는 댓글 구현

- N:1 관계에서 댓글을 담당할 Comment 모델은 N, Article 모델은 1이 될 것

![](C:\Users\SSAFY\AppData\Roaming\marktext\images\2023-04-10-08-55-19-image.png)

![](C:\Users\SSAFY\AppData\Roaming\marktext\images\2023-04-10-08-55-27-image.png)

## Django Relationship fields

### Django Relationship fields 종류

1. OneToOneField()

2. ForeignKey()

3. ManyToManyField()



### ForeignKey(to, on_delete, **options)

- A many-to-one relationship을 담당하는 Django의 모델 필드 클래스

- Django 모델에서 관계형 데이터베이스의 외래키 속성을 담당

- 2개의 필수 위치 인자가 필요

    1. 참조하는 model class

    2. on_delete 옵션



## Comment Model

### Comment 모델 정의

![](0410_DB_데이터베이스%20관계_assets/2023-04-10-09-25-42-image.png)

### ForeignKey arguments - <mark>on_delete</mark>

- 외래 키가 참조하는 객체가 사라졌을 때, 외래 키를 가진 객체를어떻게 처리할 지를 정의

- 데이터 무결성을 위해서 매우 중요한 설정

- on_delete 옵션 값
  
  - <mark>CASCADE</mark> : 부모 객체(참조된 객체)가 삭제 됐을 때 이를 참조하는 객체도 삭제(게시글 삭제하면 댓글도 삭제)
  
  - PROTECT, SET_NULL, SET_DEFAULT ... 등여러 옵션 값들이 존재(수업에서 다루지않음)

### 댓글 생성 연습

- shell_plus 실행

```bash
python manage.py shell_plus
```

![](0410_DB_데이터베이스%20관계_assets/2023-04-10-09-33-01-image.png)

![](0410_DB_데이터베이스%20관계_assets/2023-04-10-09-34-05-image.png)

: Null이면 안되는 데이터에 Null로 남겨둠

![](0410_DB_데이터베이스%20관계_assets/2023-04-10-09-37-11-image.png)

![](0410_DB_데이터베이스%20관계_assets/2023-04-10-09-36-55-image.png)

![](0410_DB_데이터베이스%20관계_assets/2023-04-10-09-38-04-image.png)

![](0410_DB_데이터베이스%20관계_assets/2023-04-10-09-38-10-image.png)

![](0410_DB_데이터베이스%20관계_assets/2023-04-10-09-40-21-image.png)

## 관계 모델 참조

### Related manager

- Related manager 는 N:1 혹은 M:N 관계에서 사용 가능한 문맥(context)

- Django는 모델 간 N:1 혹은 M:N 관계가 설정되면 <mark>역참조</mark>할 때에 사용할 수 있는 manager를 생성
  
  - 우리가 이전에 모델 생성 시 <mark>objects</mark>라는 매니저를 통해 queryset api를 사용했던 것 처럼 related manager를 통해 queryset api를 사용할 수 있게 됨

### 역참조

- 나를 참조하는 테이블을 참조하는 것

- 본인을 외래 키로 참조 중인 다른 테이블에 접근하는 것

- N:1 관계에서는 1이 N을 참조하는 상황
  
  - 외래 키를 가지지 않은 1이 외래키를 가진 N을 참조

### ![](0410_DB_데이터베이스%20관계_assets/2023-04-10-09-47-38-image.png)

- Article 모델이 Comment 모델을 참조(역참조)할 때 사용하는 매니저

- article.commet 형식으로는 댓글 객체를 참조 할 수 없음

## Comment 구현

### CREATE


